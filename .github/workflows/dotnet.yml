name: Build and Release Kannada Nudi Editor (WPF)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: write

jobs:
  build:
    name: Build WPF App
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "8.0.x"

    - name: Restore NuGet Packages
      run: dotnet restore "KannadaNudiEditor.sln"

    - name: Build Solution
      run: dotnet build "KannadaNudiEditor.sln" --configuration Release --no-restore

    - name: Publish Build Output
      run: |
        dotnet publish "KannadaNudiEditor.csproj" `
          --configuration Release `
          --output published

    - name: Zip Published Files
      run: Compress-Archive -Path published\* -DestinationPath kannadaNudi.zip
      shell: pwsh

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: kannadaNudi-build
        path: kannadaNudi.zip

  release:
    name: Clean + Create Release
    runs-on: windows-latest
    needs: build
    if: github.event_name == 'push'

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download Build Artifact
      uses: actions/download-artifact@v4
      with:
        name: kannadaNudi-build

    - name: Install GitHub CLI
      run: choco install gh -y

    - name: Delete ALL Existing Releases and Tags
      shell: pwsh
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        Write-Host "Fetching releases..."
        $releases = gh release list --limit 200 --json tagName | ConvertFrom-Json

        if ($releases.Count -eq 0) {
          Write-Host "No releases found â€” skipping cleanup."
        } else {
          foreach ($r in $releases) {
            $tag = $r.tagName
            Write-Host "Deleting release + tag $tag"
            gh release delete $tag -y
            git push origin ":$tag" 2>$null
          }
        }

    - name: Generate New Version Tag (always fresh start)
      id: version
      shell: pwsh
      run: |
        $NEW="v1.0.0"
        echo "NEW_VERSION=$NEW" >> $env:GITHUB_ENV
        Write-Host "Using fresh version: $NEW"

    - name: Create and Push Tag
      run: |
        git tag ${{ env.NEW_VERSION }}
        git push origin ${{ env.NEW_VERSION }}

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.NEW_VERSION }}
        files: kannadaNudi.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
