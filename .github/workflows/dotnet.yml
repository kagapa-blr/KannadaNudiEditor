name: Build and Release Kannada Nudi Editor (WPF)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build:
    name: Build and Publish WPF App
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore NuGet Packages
        run: dotnet restore "KannadaNudiEditor.sln"

      - name: Build Solution
        run: dotnet build "KannadaNudiEditor.sln" --configuration Release --no-restore

      - name: Publish Build Output
        run: dotnet publish "KannadaNudiEditor.csproj" --configuration Release --output setup/publish

      - name: Verify Publish Folder
        run: |
          Write-Host "Current working directory: $PWD"
          Write-Host "Contents of setup folder:"
          Get-ChildItem "setup" | ForEach-Object { Write-Host $_.FullName }

      - name: Upload Publish Folder (Optional)
        uses: actions/upload-artifact@v4
        with:
          name: publish-folder
          path: setup/publish

  release:
    name: Create GitHub Release with Installer
    runs-on: windows-latest
    needs: build

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Publish Artifact
        uses: actions/download-artifact@v4
        with:
          name: publish-folder
          path: setup/publish

      - name: Get Latest Version Number
        id: get_version
        shell: pwsh
        run: |
          git fetch --tags
          $latest = git tag -l --sort=-v:refname | Where-Object { $_ -match '^\d+\.\d+\.\d+$' } | Select-Object -First 1
          if (-not $latest) {
              $new_version = "1.0.0"
          } else {
              $parts = $latest.Split('.')
              $patch = [int]$parts[2] + 1
              $new_version = "$($parts[0]).$($parts[1]).$patch"
          }
          echo "RELEASE_VERSION=$new_version" >> $env:GITHUB_ENV
          Write-Host "New release version: $new_version"

      - name: Download & Install Inno Setup
        shell: pwsh
        run: |
          $url = "https://jrsoftware.org/download.php/is.exe?site=1"
          $installer = "$env:TEMP\inno_setup.exe"
          Invoke-WebRequest -Uri $url -OutFile $installer
          Start-Process -FilePath $installer -ArgumentList "/VERYSILENT /NORESTART /ALLUSERS" -Wait

      - name: Update Inno Setup Script Version
        shell: pwsh
        run: |
          $issFile = "setup\NudiBaravanigeSetup.iss"
          (Get-Content $issFile) -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$env:RELEASE_VERSION`"" | Set-Content $issFile
          Write-Host "Updated ISS file version to $env:RELEASE_VERSION"

      - name: Compile Inno Setup Installer
        shell: pwsh
        run: |
          Write-Host "Current working directory: $PWD"
          Write-Host "Contents of setup folder:"
          Get-ChildItem "setup" | ForEach-Object { Write-Host $_.FullName }

          $ISCC = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          $issFile = Join-Path $PWD "setup\NudiBaravanigeSetup.iss"
          Write-Host "Using ISS file: $issFile"

          # Check if publish folder exists
          $publishFolder = "$PWD\setup\publish"
          if (Test-Path $publishFolder) {
              Write-Host "Publish folder exists. Contents:"
              Get-ChildItem $publishFolder -Recurse | ForEach-Object { Write-Host $_.FullName }
          }
          else {
              Write-Host "Publish folder is missing!"
              Exit 1
          }

          # Compile the installer
          & $ISCC $issFile

      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: KannadaNudiInstaller
          path: setup\Output\*.exe

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_VERSION }}
          files: setup\Output\*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
