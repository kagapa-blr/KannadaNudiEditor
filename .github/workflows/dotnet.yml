name: Build and Release Kannada Nudi Editor (WPF)

on:
  push:
    branches: ["main"]     # Release only after merge to main
  pull_request:
    branches: ["main"]     # Build only

permissions:
  contents: write

jobs:
  build:
    name: Build WPF App
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "8.0.x"

    - name: Restore NuGet Packages
      run: dotnet restore "KannadaNudiEditor.sln"

    - name: Build Solution
      run: dotnet build "KannadaNudiEditor.sln" --configuration Release --no-restore

    - name: Publish Build Output
      run: |
        dotnet publish "KannadaNudiEditor.csproj" `
          --configuration Release `
          --output published

    - name: Zip Published Files
      run: Compress-Archive -Path published\* -DestinationPath kannadaNudi.zip
      shell: pwsh

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: kannadaNudi-build
        path: kannadaNudi.zip

  release:
    name: Clean Old Releases & Create Fresh One
    runs-on: windows-latest
    needs: build
    if: github.event_name == 'push'

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download Build Artifact
      uses: actions/download-artifact@v4
      with:
        name: kannadaNudi-build

    # ðŸ§¹ DELETE ALL EXISTING RELEASES & TAGS
    - name: Delete all existing releases and tags
      shell: pwsh
      run: |
        gh release list --limit 100 | ForEach-Object {
          $tag = $_.Split(" ")[0]
          Write-Host "Deleting release + tag $tag"
          gh release delete $tag --yes
          git push origin ":$tag"
        }
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ðŸ†• ALWAYS START FRESH FROM v1.0.0 AND INCREMENT
    - name: Determine New Version Tag
      id: version
      shell: pwsh
      run: |
        git fetch --tags
        $LATEST = git tag -l 'v*' --sort=-v:refname |
          Where-Object { $_ -match '^v\d+\.\d+\.\d+$' } |
          Select-Object -First 1

        if (-not $LATEST) {
          $NEW = "v1.0.0"
        } else {
          $v = $LATEST.TrimStart('v').Split('.')
          $patch = [int]$v[2] + 1
          $NEW = "v$($v[0]).$($v[1]).$patch"
        }

        echo "NEW_VERSION=$NEW" >> $env:GITHUB_ENV
        echo "New version: $NEW"

    - name: Create and Push Tag
      run: |
        git tag ${{ env.NEW_VERSION }}
        git push origin ${{ env.NEW_VERSION }}

    - name: Create Fresh GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.NEW_VERSION }}
        files: kannadaNudi.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
