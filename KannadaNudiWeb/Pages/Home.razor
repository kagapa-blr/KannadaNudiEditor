@page "/"
@using KannadaNudiWeb.Services
@using KannadaNudiEditor.Helpers.Conversion
@inject TransliterationService TransliterationService
@inject FileConversionService FileConversionService
@inject SpeechService SpeechService
@inject IJSRuntime JSRuntime

<PageTitle>Kannada Nudi Editor</PageTitle>

<div class="toolbar-container">
    <div class="toolbar-group">
        <label class="toolbar-label">Input Mode:</label>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="inputModeSwitch" checked="@IsKannadaInput" @onchange="OnInputModeChange">
            <label class="form-check-label" for="inputModeSwitch">@(IsKannadaInput ? "KAN" : "ENG")</label>
        </div>
    </div>

    @if (IsKannadaInput)
    {
        <div class="toolbar-group">
            <label class="toolbar-label">Layout:</label>
            <select class="form-select" style="width:auto; display:inline-block;" @onchange="OnLayoutChange">
                <option value="Nudi">Nudi/KGP</option>
                <option value="Baraha">Baraha (Phonetic)</option>
            </select>
        </div>
    }

    <div class="toolbar-group">
         <button class="btn @(isListening ? "btn-danger" : "btn-primary")" @onclick="ToggleSpeech">
             <span class="bi bi-mic"></span> @(isListening ? "Stop Speech" : "Start Speech")
         </button>
         <select class="form-select ms-2" style="width:auto; display:inline-block;" @bind="speechLang">
             <option value="kn-IN">Kannada</option>
             <option value="en-IN">English</option>
         </select>
    </div>

    <div class="toolbar-group">
        <div class="btn-group" role="group">
            <button class="btn btn-outline-dark" @onclick="Undo" title="Undo"><span class="bi bi-arrow-counterclockwise"></span></button>
            <button class="btn btn-outline-dark" @onclick="Redo" title="Redo"><span class="bi bi-arrow-clockwise"></span></button>
        </div>
        <div class="btn-group ms-2" role="group">
            <button class="btn btn-outline-dark" @onclick="CopyText" title="Copy"><span class="bi bi-clipboard"></span></button>
            <button class="btn btn-outline-dark" @onclick="PasteText" title="Paste"><span class="bi bi-clipboard-check"></span></button>
        </div>
        <div class="btn-group ms-2" role="group">
            <button class="btn btn-outline-dark" @onclick="InsertTable" title="Insert Table (3x3)" style="display:none"><span class="bi bi-table"></span></button>
            <button class="btn btn-outline-dark" @onclick="ToggleHighlight" title="Highlight Text"><span class="bi bi-highlighter"></span></button>
        </div>
    </div>

    <div class="toolbar-group">
         <button class="btn btn-secondary" @onclick="SaveDocument">
             <span class="bi bi-save"></span> Save
         </button>
         <InputFile OnChange="LoadDocument" class="file-input-hidden" id="fileUpload" accept=".txt, .docx, application/vnd.openxmlformats-officedocument.wordprocessingml.document, text/plain" />
         <label for="fileUpload" class="btn btn-secondary"><span class="bi bi-folder2-open"></span> Open</label>
    </div>
</div>

<div id="editor-wrapper" tabindex="0" style="outline:none;">
    <div id="quill-editor"></div>
</div>

@if (showSaveModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show" style="display:block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Save Document</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="filenameInput" class="form-label">Filename</label>
                        <input type="text" class="form-control" id="filenameInput" @bind="saveFileName">
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" @onclick="DownloadDocx">Download as DocX</button>
                        <button class="btn btn-secondary" @onclick="DownloadTxt">Download as TXT</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showImportModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show" style="display:block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import File (@pendingFileName)</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <p>How should the content of this file be interpreted?</p>

                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="importType" id="importUnicode" value="Unicode" checked="@(importType == "Unicode")" @onchange="@(() => importType = "Unicode")">
                        <label class="form-check-label" for="importUnicode">
                            <strong>Unicode (Standard)</strong><br/>
                            <small class="text-muted">Use this if the file already contains readable Kannada text.</small>
                        </label>
                    </div>

                    <div class="form-check mt-3">
                        <input class="form-check-input" type="radio" name="importType" id="importAscii" value="ASCII" checked="@(importType == "ASCII")" @onchange="@(() => importType = "ASCII")">
                        <label class="form-check-label" for="importAscii">
                            <strong>ASCII (Nudi/Baraha)</strong><br/>
                            <small class="text-muted">Use this if the file contains English characters (e.g. "r", "k") that look like Kannada when using Nudi fonts.</small>
                        </label>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="FinishImport">Import</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Removed <script> block, logic moved to quillInterop.js -->

<style>
    .toolbar-container {
        display: flex;
        gap: 20px;
        padding: 10px;
        background: #f3f3f3;
        border-bottom: 1px solid #ccc;
        align-items: center;
        flex-shrink: 0;
    }
    .toolbar-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    @@media (max-width: 600px) {
        .toolbar-container {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

        .toolbar-group {
            justify-content: space-between;
        }
    }

    #editor-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    #quill-editor {
        flex: 1;
        overflow: hidden;
    }

    .file-input-hidden {
        display: none;
    }
    .modal-backdrop {
        background-color: rgba(0,0,0,0.5);
    }
</style>

@code {
    public bool IsKannadaInput { get; set; } = true;

    bool isListening = false;
    bool showSaveModal = false;
    string saveFileName = "Document";
    string speechLang = "kn-IN";
    DotNetObjectReference<Home>? objRef;

    protected override async Task OnInitializedAsync()
    {
        objRef = DotNetObjectReference.Create(this);
        await TransliterationService.InitializeAsync();
        SpeechService.OnResult += OnSpeechResult;
        SpeechService.OnError += OnSpeechError;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("quillInterop.init", "#quill-editor", objRef);
            // Updated call to use namespaced function
            await JSRuntime.InvokeVoidAsync("quillInterop.registerKeyInterceptor", objRef);
            await JSRuntime.InvokeVoidAsync("quillInterop.setKannadaMode", IsKannadaInput);
        }
    }

    private async Task OnInputModeChange(ChangeEventArgs args)
    {
        IsKannadaInput = (bool)(args.Value ?? false);
        if (!IsKannadaInput)
        {
            TransliterationService.ClearBuffer();
        }
        await JSRuntime.InvokeVoidAsync("quillInterop.setKannadaMode", IsKannadaInput);
    }

    private void OnLayoutChange(ChangeEventArgs args)
    {
        if (args.Value != null && Enum.TryParse<KeyboardLayout>(args.Value.ToString(), out var layout))
        {
            TransliterationService.SetLayout(layout);
        }
    }

    [JSInvokable]
    public void OnSelectionChanged()
    {
        TransliterationService.ClearBuffer();
    }

    [JSInvokable]
    public void ProcessBackspace()
    {
        TransliterationService.RemoveLast();
    }

    [JSInvokable]
    public async Task ProcessKannadaKey(string key)
    {
        var result = TransliterationService.GetTransliteration(key);

        if (result.backspaceCount > 0)
        {
            await JSRuntime.InvokeVoidAsync("quillInterop.backspace", result.backspaceCount);
        }

        if (!string.IsNullOrEmpty(result.text))
        {
            await JSRuntime.InvokeVoidAsync("quillInterop.insertText", result.text);
        }
    }

    private async void ToggleSpeech()
    {
        if (isListening)
        {
            await SpeechService.StopAsync();
            isListening = false;
        }
        else
        {
            await SpeechService.StartAsync(speechLang);
            isListening = true;
        }
    }

    private void OnSpeechResult(string text)
    {
        InvokeAsync(async () =>
        {
            await JSRuntime.InvokeVoidAsync("quillInterop.insertText", text + " ");
        });
    }

    private void OnSpeechError(string error)
    {
        Console.WriteLine($"Speech Error: {error}");
        isListening = false;
        StateHasChanged();
    }

    private async Task Undo()
    {
        await JSRuntime.InvokeVoidAsync("quillInterop.undo");
    }

    private async Task Redo()
    {
        await JSRuntime.InvokeVoidAsync("quillInterop.redo");
    }

    private async Task CopyText()
    {
        await JSRuntime.InvokeVoidAsync("quillInterop.copyText");
    }

    private async Task PasteText()
    {
        await JSRuntime.InvokeVoidAsync("quillInterop.pasteText");
    }

    private async Task InsertTable()
    {
        await JSRuntime.InvokeVoidAsync("quillInterop.insertTable", 3, 3);
    }

    private async Task ToggleHighlight()
    {
        await JSRuntime.InvokeVoidAsync("quillInterop.toggleHighlight");
    }

    private void SaveDocument()
    {
        showSaveModal = true;
    }

    private void CloseModal()
    {
        showSaveModal = false;
        showImportModal = false;
        pendingFileBytes = null;
    }

    private async Task DownloadDocx()
    {
        string html = await JSRuntime.InvokeAsync<string>("quillInterop.getHtml");
        string filename = string.IsNullOrWhiteSpace(saveFileName) ? "Document.docx" : $"{saveFileName}.docx";
        await JSRuntime.InvokeVoidAsync("quillInterop.saveAsDocx", filename, html);
        CloseModal();
    }

    private async Task DownloadTxt()
    {
        string text = await JSRuntime.InvokeAsync<string>("quillInterop.getText");
        string filename = string.IsNullOrWhiteSpace(saveFileName) ? "Document.txt" : $"{saveFileName}.txt";
        await JSRuntime.InvokeVoidAsync("quillInterop.downloadFile", filename, text, "text/plain");
        CloseModal();
    }

    // Import Logic
    bool showImportModal = false;
    string importType = "Unicode"; // "Unicode" or "ASCII"
    string pendingFileName = "";
    string pendingFileExtension = "";
    byte[]? pendingFileBytes;

    private async Task LoadDocument(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            pendingFileName = file.Name;
            pendingFileExtension = Path.GetExtension(file.Name).ToLowerInvariant();

            if (pendingFileExtension != ".txt" && pendingFileExtension != ".docx")
            {
                Console.WriteLine("Unsupported file type");
                return;
            }

            // Read file into memory
            using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024); // 5MB limit
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            pendingFileBytes = ms.ToArray();

            // Show options modal
            importType = "Unicode"; // Reset to default
            showImportModal = true;
        }
        catch(Exception ex)
        {
            Console.WriteLine("Error loading file: " + ex.Message);
        }
    }

    private async Task FinishImport()
    {
        if (pendingFileBytes == null) return;

        try
        {
            string htmlContent = "";

            if (pendingFileExtension == ".txt")
            {
                // Assume UTF-8 for now, but could be ASCII if user says so?
                // If user selected ASCII mode, it means the CONTENT is visually ASCII (Nudi),
                // but the file encoding is likely ANSI or UTF-8.
                // We'll decode as UTF-8 string first.
                string rawText = System.Text.Encoding.UTF8.GetString(pendingFileBytes);

                if (importType == "ASCII")
                {
                    htmlContent = FileConversionService.AsciiToUnicodeConverter(rawText);
                    // Wrap in p tags for Quill? Quill handles plain text usually, but setHtml expects HTML.
                    // Let's wrap in <p> or just let Quill handle it.
                    // But AsciiToUnicodeConverter returns plain text.
                    // Escaping HTML chars in text is safer.
                    htmlContent = System.Net.WebUtility.HtmlEncode(htmlContent).Replace("\n", "<br>");
                }
                else
                {
                    htmlContent = System.Net.WebUtility.HtmlEncode(rawText).Replace("\n", "<br>");
                }
            }
            else if (pendingFileExtension == ".docx")
            {
                // Convert Docx to HTML using Mammoth (JS)
                htmlContent = await JSRuntime.InvokeAsync<string>("quillInterop.docToHtml", pendingFileBytes);

                if (importType == "ASCII")
                {
                    htmlContent = ProcessHtmlAsciiToUnicode(htmlContent);
                }
            }

            if (!string.IsNullOrEmpty(htmlContent))
            {
                await JSRuntime.InvokeVoidAsync("quillInterop.setHtml", htmlContent);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error importing file: " + ex.Message);
        }
        finally
        {
            CloseModal();
        }
    }

    private string ProcessHtmlAsciiToUnicode(string html)
    {
        // Simple HTML walker: split by tags
        var parts = System.Text.RegularExpressions.Regex.Split(html, @"(<[^>]+>)");
        var sb = new System.Text.StringBuilder();

        foreach (var part in parts)
        {
            if (part.StartsWith("<") && part.EndsWith(">"))
            {
                sb.Append(part);
            }
            else if (!string.IsNullOrEmpty(part))
            {
                // This is text content.
                // 1. Decode HTML entities (e.g. &nbsp; to space, &lt; to <)
                string decoded = System.Net.WebUtility.HtmlDecode(part);

                // 2. Convert Nudi ASCII to Unicode
                string converted = FileConversionService.AsciiToUnicodeConverter(decoded);

                // 3. Re-encode HTML special chars (e.g. < to &lt;) to prevent breaking HTML
                string encoded = System.Net.WebUtility.HtmlEncode(converted);

                sb.Append(encoded);
            }
        }
        return sb.ToString();
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}
